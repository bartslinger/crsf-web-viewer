<script lang="ts">
	import { crc8DvbS2 } from '$lib/crc';

	const input = JSON.parse(
		'\t\t[{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":80,"14":157,"15":234,"16":13,"17":58,"18":234,"19":238,"20":16,"21":0,"22":0,"23":156,"24":64,"25":0,"26":0,"27":0,"28":27,"29":131,"30":234,"31":13,"32":58,"33":234,"34":238,"35":16,"36":0,"37":0,"38":156,"39":64,"40":0,"41":0,"42":0,"43":73,"44":51,"45":234,"46":13,"47":58,"48":234,"49":238,"50":16,"51":0,"52":0,"53":156,"54":64,"55":255,"56":255,"57":255,"58":246,"59":143,"60":234,"61":13,"62":58,"63":234,"64":238,"65":16,"66":0,"67":0,"68":156,"69":64,"70":0,"71":0,"72":0,"73":50,"74":219,"75":234,"76":13,"77":58,"78":234,"79":238,"80":16,"81":0,"82":0,"83":156,"84":64,"85":0,"86":0,"87":0,"88":51,"89":14,"90":234,"91":13,"92":58,"93":234,"94":238,"95":16,"96":0,"97":0,"98":156,"99":64,"100":0,"101":0,"102":0,"103":30,"104":168,"105":234,"106":13,"107":58,"108":234,"109":238,"110":16,"111":0,"112":0,"113":156,"114":64,"115":255,"116":255,"117":255,"118":245,"119":37,"120":234,"121":13,"122":58,"123":234,"124":238,"125":16,"126":0,"127":0,"128":156,"129":64,"130":0,"131":0,"132":0,"133":84,"134":99,"135":234,"136":13,"137":58,"138":234,"139":238,"140":16,"141":0,"142":0,"143":156,"144":64,"145":0,"146":0,"147":0,"148":26,"149":86,"150":234,"151":13,"152":58,"153":234,"154":238,"155":16,"156":0,"157":0,"158":156,"159":64,"160":0,"161":0,"162":0,"163":78,"164":103,"165":234,"166":13,"167":58,"168":234,"169":238,"170":16,"171":0,"172":0,"173":156,"174":64,"175":0,"176":0,"177":0,"178":3,"179":248,"180":234,"181":13,"182":58,"183":234,"184":238,"185":16,"186":0,"187":0,"188":156,"189":64,"190":0,"191":0,"192":0,"193":64,"194":207,"195":234,"196":13,"197":58,"198":234,"199":238,"200":16,"201":0,"202":0,"203":156,"204":64,"205":0,"206":0,"207":0,"208":13,"209":80,"210":234,"211":13,"212":58,"213":234,"214":238,"215":16,"216":0,"217":0,"218":156,"219":64,"220":0,"221":0,"222":0,"223":32,"224":246,"225":234,"226":13,"227":58,"228":234,"229":238,"230":16,"231":0,"232":0,"233":156,"234":64,"235":0,"236":0,"237":0,"238":84,"239":99,"240":234,"241":13,"242":58,"243":234,"244":238,"245":16,"246":0,"247":0,"248":156,"249":64,"250":0,"251":0,"252":0,"253":56,"254":141},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":255,"11":255,"12":255,"13":217,"14":86,"15":234,"16":13,"17":58,"18":234,"19":238,"20":16,"21":0,"22":0,"23":156,"24":64,"25":0,"26":0,"27":0,"28":74,"29":153,"30":234,"31":13,"32":58,"33":234,"34":238,"35":16,"36":0,"37":0,"38":156,"39":64,"40":0,"41":0,"42":0,"43":44,"44":33,"45":234,"46":13,"47":58,"48":234,"49":238,"50":16,"51":0,"52":0,"53":156,"54":64,"55":0,"56":0,"57":0,"58":94,"59":53,"60":234,"61":13,"62":58,"63":234,"64":238,"65":16,"66":0,"67":0,"68":156,"69":64,"70":0,"71":0,"72":0,"73":21,"74":43,"75":234,"76":13,"77":58,"78":234,"79":238,"80":16,"81":0,"82":0,"83":156,"84":64,"85":0,"86":0,"87":0,"88":8,"89":123,"90":234,"91":13,"92":58,"93":234,"94":238,"95":16,"96":0,"97":0,"98":156,"99":64,"100":0,"101":0,"102":0,"103":55,"104":240,"105":234,"106":13,"107":58,"108":234,"109":238,"110":16,"111":0,"112":0,"113":156,"114":64,"115":0,"116":0,"117":0,"118":2,"119":45,"120":234,"121":13,"122":58,"123":234,"124":238,"125":16,"126":0,"127":0,"128":156,"129":64,"130":0,"131":0,"132":0,"133":48,"134":164,"135":234,"136":13,"137":58,"138":234,"139":238,"140":16,"141":0,"142":0,"143":156,"144":64,"145":0,"146":0,"147":0,"148":10,"149":4,"150":234,"151":13,"152":58,"153":234,"154":238,"155":16,"156":0,"157":0,"158":156,"159":64,"160":0,"161":0,"162":0,"163":24,"164":41,"165":234,"166":13,"167":58,"168":234,"169":238,"170":16,"171":0,"172":0,"173":156,"174":64,"175":0,"176":0,"177":0,"178":100,"179":149,"180":234,"181":13,"182":58,"183":234,"184":238,"185":16,"186":0,"187":0,"188":156,"189":64,"190":255,"191":255,"192":255,"193":201,"194":4,"195":234,"196":13,"197":58,"198":234,"199":238,"200":16,"201":0,"202":0,"203":156,"204":64,"205":0,"206":0,"207":0,"208":80,"209":157,"210":234,"211":13,"212":58,"213":234,"214":238,"215":16,"216":0,"217":0,"218":156,"219":64,"220":0,"221":0,"222":0,"223":43,"224":117,"225":234,"226":13,"227":58,"228":234,"229":238,"230":16,"231":0,"232":0,"233":156,"234":64,"235":0,"236":0,"237":0,"238":38,"239":119,"240":234,"241":13,"242":58,"243":234,"244":238,"245":16,"246":0,"247":0,"248":156,"249":64,"250":0,"251":0,"252":0,"253":73,"254":51},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":11,"14":209,"15":234,"16":13,"17":58,"18":234,"19":238,"20":16,"21":0,"22":0,"23":156,"24":64,"25":0,"26":0,"27":0,"28":21,"29":43,"30":234,"31":13,"32":58,"33":234,"34":238,"35":16,"36":0,"37":0,"38":156,"39":64,"40":0,"41":0,"42":0,"43":59,"44":39,"45":234,"46":13,"47":58,"48":234,"49":238,"50":16,"51":0,"52":0,"53":156,"54":64,"55":0,"56":0,"57":0,"58":19,"59":170,"60":234,"61":13,"62":58,"63":234,"64":238,"65":16,"66":0,"67":0,"68":156,"69":64,"70":0,"71":0,"72":0,"73":8,"74":123,"75":234,"76":13,"77":58,"78":234,"79":238,"80":16,"81":0,"82":0,"83":156,"84":64,"85":0,"86":0,"87":0,"88":106,"89":61,"90":234,"91":13,"92":58,"93":234,"94":238,"95":16,"96":0,"97":0,"98":156,"99":64,"100":0,"101":0,"102":0,"103":44,"104":33,"105":234,"106":13,"107":58,"108":234,"109":238,"110":16,"111":0,"112":0,"113":156,"114":64,"115":255,"116":255,"117":255,"118":245,"119":37,"120":234,"121":13,"122":58,"123":234,"124":238,"125":16,"126":0,"127":0,"128":156,"129":64,"130":0,"131":0,"132":0,"133":48,"134":164,"135":234,"136":13,"137":58,"138":234,"139":238,"140":16,"141":0,"142":0,"143":156,"144":64,"145":0,"146":0,"147":0,"148":92,"149":74,"150":234,"151":13,"152":58,"153":234,"154":238,"155":16,"156":0,"157":0,"158":156,"159":64,"160":255,"161":255,"162":255,"163":246,"164":143,"165":234,"166":13,"167":58,"168":234,"169":238,"170":16,"171":0,"172":0,"173":156,"174":64,"175":0,"176":0,"177":0,"178":56,"179":141,"180":234,"181":13,"182":58,"183":234,"184":238,"185":16,"186":0,"187":0,"188":156,"189":64,"190":0,"191":0,"192":0,"193":4,"194":172,"195":234,"196":13,"197":58,"198":234,"199":238,"200":16,"201":0,"202":0,"203":156,"204":64,"205":0,"206":0,"207":0,"208":17,"209":213,"210":234,"211":13,"212":58,"213":234,"214":238,"215":16,"216":0,"217":0,"218":156,"219":64,"220":0,"221":0,"222":0,"223":109,"224":105,"225":234,"226":13,"227":58,"228":234,"229":238,"230":16,"231":0,"232":0,"233":156,"234":64,"235":255,"236":255,"237":255,"238":248,"239":39,"240":234,"241":13,"242":58,"243":234,"244":238,"245":16,"246":0,"247":0,"248":156,"249":64,"250":0,"251":0,"252":0,"253":35,"254":92},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":27,"14":131,"15":234,"16":13,"17":58,"18":234,"19":238,"20":16,"21":0,"22":0,"23":156,"24":64,"25":0,"26":0,"27":0,"28":16,"29":0,"30":234,"31":13,"32":58,"33":234,"34":238,"35":16,"36":0,"37":0,"38":156,"39":64,"40":0,"41":0,"42":0,"43":124,"44":238,"45":234,"46":13,"47":58,"48":234,"49":238,"50":16,"51":0,"52":0,"53":156,"54":64,"55":0,"56":0,"57":0,"58":10,"59":4,"60":234,"61":13,"62":58,"63":234,"64":238,"65":16,"66":0,"67":0,"68":156,"69":64,"70":0,"71":0,"72":0,"73":68,"74":49,"75":234,"76":13,"77":58,"78":234,"79":238,"80":16,"81":0,"82":0,"83":156,"84":64,"85":255,"86":255,"87":255,"88":238,"89":244,"90":234,"91":13,"92":58,"93":234,"94":238,"95":16,"96":0,"97":0,"98":156,"99":64,"100":0,"101":0,"102":0,"103":58,"104":242,"105":234,"106":13,"107":58,"108":234,"109":238,"110":16,"111":0,"112":0,"113":156,"114":64,"115":0,"116":0,"117":0,"118":1,"119":135,"120":234,"121":13,"122":58,"123":234,"124":238,"125":16,"126":0,"127":0,"128":156,"129":64,"130":0,"131":0,"132":0,"133":52,"134":90,"135":234,"136":13,"137":58,"138":234,"139":238,"140":16,"141":0,"142":0,"143":156,"144":64,"145":0,"146":0,"147":0,"148":42,"149":160,"150":234,"151":13,"152":58,"153":234,"154":238,"155":16,"156":0,"157":0,"158":156,"159":64,"160":0,"161":0,"162":0,"163":30,"164":168,"165":234,"166":13,"167":58,"168":234,"169":238,"170":16,"171":0,"172":0,"173":156,"174":64,"175":0,"176":0,"177":0,"178":52,"179":90,"180":234,"181":13,"182":58,"183":234,"184":238,"185":16,"186":0,"187":0,"188":156,"189":64,"190":255,"191":255,"192":255,"193":234,"194":10,"195":234,"196":13,"197":58,"198":234,"199":238,"200":16,"201":0,"202":0,"203":156,"204":64,"205":0,"206":0,"207":0,"208":90,"209":203,"210":234,"211":13,"212":58,"213":234,"214":238,"215":16,"216":0,"217":0,"218":156,"219":64,"220":255,"221":255,"222":255,"223":236,"224":139,"225":234,"226":13,"227":58,"228":234},{"0":16,"1":0,"2":0,"3":156,"4":64,"5":0,"6":0,"7":0,"8":56,"9":141,"10":234,"11":13,"12":58,"13":234,"14":238,"15":16,"16":0,"17":0,"18":156,"19":64,"20":0,"21":0,"22":0,"23":58,"24":242,"25":234},{"0":13,"1":58,"2":234,"3":238,"4":16,"5":0,"6":0,"7":156,"8":64,"9":0,"10":0,"11":0,"12":2,"13":45},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":39,"14":162},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":96,"14":107},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":255,"11":255,"12":255,"13":221,"14":168},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":98,"14":20},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":255,"11":255,"12":255,"13":215,"14":254},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":95,"14":224},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":61,"14":166},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":255,"11":255,"12":255,"13":254,"14":166},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":255,"11":255,"12":255,"13":251,"14":141},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":23,"14":84},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":83,"14":55},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":27,"14":131},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":98,"14":20},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":255,"11":255,"12":255,"13":220,"14":125},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":46,"14":94},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":70,"14":78},{"0":234},{"0":13,"1":58,"2":234,"3":238,"4":16,"5":0,"6":0,"7":156,"8":64,"9":0,"10":0,"11":0,"12":39,"13":162},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":255,"11":255,"12":255,"13":241,"14":219},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":53,"14":143},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":27,"14":131},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":104,"14":66},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":9,"14":174},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":12,"14":133},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":100,"14":149},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":46,"14":94},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":255,"11":255,"12":255,"13":210,"14":213},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":104,"14":66},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":255,"11":255,"12":255,"13":252,"14":217},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":24,"14":41},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":61,"14":166},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":20,"14":254},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":255,"11":255,"12":255,"13":250,"14":88},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":28,"14":215},{"0":234},{"0":13,"1":58,"2":234,"3":238,"4":16,"5":0,"6":0,"7":156,"8":64,"9":0,"10":0,"11":0,"12":80,"13":157},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":255,"11":255,"12":255,"13":247,"14":90},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":68,"14":49},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":36,"14":8},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":48,"14":164},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":10,"14":4},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":67,"14":101},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":39,"14":162},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":52,"14":90},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":255,"11":255,"12":255,"13":255,"14":115},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":57,"14":88},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":47,"14":139},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":70,"14":78},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":29,"14":2},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":255,"11":255,"12":255,"13":223,"14":215},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":24,"14":41},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":78,"14":103},{"0":234},{"0":13,"1":58,"2":234,"3":238,"4":16,"5":0,"6":0,"7":156,"8":64,"9":0,"10":0,"11":0,"12":57,"13":88},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":69,"14":228},{"0":234,"1":13,"2":58,"3":234,"4":238,"5":16,"6":0,"7":0,"8":156,"9":64,"10":0,"11":0,"12":0,"13":8,"14":123}]\n'
	);
	let uint8Arrays = [];
	for (const message of input) {
		const bytes: number[] = Object.values(message);
		const byteArray = new Uint8Array(bytes);
		uint8Arrays.push(byteArray);
		break;
	}

	// Function to create a ReadableStream from an array of Uint8Arrays
	function createReadableStreamFromUint8ArrayArray(uint8Arrays: Uint8Array[]) {
		return new ReadableStream({
			start(controller) {
				uint8Arrays.forEach((uint8Array) => {
					controller.enqueue(uint8Array);
				});
				controller.close();
			}
		});
	}

	class CrsfFramingTransformer {
		buffer: number[];

		constructor() {
			// A container for holding stream data until a new line.
			this.buffer = [];
		}

		transform(chunk: Uint8Array, controller) {
			this.buffer = [...this.buffer, ...chunk];

			// delete bytes until the first value in buffer is 234
			while (this.buffer.length > 0 && this.buffer[0] !== 0xea) {
				this.buffer.shift();
			}
			if (this.buffer.length === 0) {
				return;
			}

			// find all positions of 0xea in the buffer
			const frameStartIndices = [];
			for (let i = 0; i < this.buffer.length; i++) {
				if (this.buffer[i] === 0xea) {
					frameStartIndices.push(i);
				}
			}

			for (const frameStartIndex of frameStartIndices) {
				if (this.buffer.length < frameStartIndex + 3) {
					// should at least have start byte, frame length, message type and crc
					break;
				}
				const frameLength = this.buffer[frameStartIndex + 1] + 2;
				if (this.buffer.length < frameStartIndex + frameLength) {
					// maybe the message is not complete yet
					// or maybe the length byte is corrupted, there might be a next 0xea
					continue;
				}
				const slice = this.buffer.slice(frameStartIndex, frameStartIndex + frameLength);
				// console.log(slice);
				const crc_relevant_slice = slice.slice(2, slice.length - 1);
				// console.log(crc_relevant_slice);
				const calculated_crc = crc8DvbS2(crc_relevant_slice);
				const actual_crc = slice[frameLength - 1];
				console.log(calculated_crc, actual_crc);
			}
			// 	if (this.buffer.length < frameStartIndex + frameLength) {
			// 		// maybe the message is not complete yet
			// 		// or maybe the length byte is corrupted, there might be a next 0xea
			// 		continue;
			// 	}
			// 	const frame = this.buffer.slice(frameStartIndex, frameStartIndex + frameLength);
			// 	controller.enqueue(frame);
			// 	this.buffer = this.buffer.slice(frameStartIndex + frameLength);
			// }

			// // for each 0xea in the buffer, check if that is the start of a valid frame
			// while (this.buffer.length > 0) {
			// 	const frameStartIndex = this.buffer.indexOf(0xea);
			// 	if (frameStartIndex === -1) {
			// 		break;
			// 	}
			// 	if (this.buffer.length < frameStartIndex + 3) {
			// 		// should at least have start byte, frame length, message type and crc
			// 		break;
			// 	}
			// 	const frameLength = this.buffer[frameStartIndex + 1];
			// 	if (this.buffer.length < frameStartIndex + frameLength) {
			// 		// maybe the message is not complete yet
			// 		// or maybe the length byte is corrupted, there might be a next 0xea
			// 		continue;
			// 	}
			// 	const frame = this.buffer.slice(frameStartIndex, frameStartIndex + frameLength);
			// 	controller.enqueue(frame);
			// 	this.buffer = this.buffer.slice(frameStartIndex + frameLength);
			// }

			// Append new chunks to existing chunks.
			// this.chunks += chunk;
			// // For each line breaks in chunks, send the parsed lines out.
			// const lines = this.chunks.split("\r\n");
			// this.chunks = lines.pop();
			// lines.forEach((line) => controller.enqueue(line));
		}

		flush(controller) {
			// When the stream is closed, flush any remaining chunks out.
			// controller.enqueue(this.buffer);
		}
	}

	const readableStream = createReadableStreamFromUint8ArrayArray(uint8Arrays);

	// Example of consuming the stream
	// const reader = readableStream.getReader();

	const myDecoder = new TransformStream(new CrsfFramingTransformer());
	// pipe it to a decoder
	const readableStreamClosed = readableStream.pipeTo(myDecoder.writable);
	const reader = myDecoder.readable.getReader();

	const go = async () => {
		while (true) {
			const { value, done } = await reader.read();
			if (done) break;
			//console.log(value);
		}
	};
	go();

	/*
	CRSF frame has the structure:
	<Device address> <Frame length> <Type> <Payload> <CRC>
	Device address: (uint8_t)
	Frame length:   length in  bytes including Type (uint8_t)
	Type:           (uint8_t)
	CRC:            (uint8_t), crc of <Type> and <Payload>
	*/
</script>
